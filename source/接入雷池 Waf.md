# 背景

iLinks 目前是这样部署的：

- 一台线路不错的转发机 A，带DDOS。

- 一台线路一般，但是性能更好的真实服务器 B。

对外暴露 A 的 IP，被打时候把域名解析转到 CF，CF 直接到源站。

但我A 机器本身是没法防 CC 的，于是，本文来了：

[雷池 WAF 社区版 | 下一代 Web 应用防火墙 | 免费安装 (chaitin.cn)](https://waf-ce.chaitin.cn/)

一个免费的 WAF 。

# 安装

[安装雷池 | 雷池 WAF 社区版 (chaitin.cn)](https://waf-ce.chaitin.cn/docs/guide/install)

根据这个文档。安装还是很简单的，一键脚本。

# 登录部署

这里注意，登录一定要用 https 协议，你的 ip + 雷池端口。

部署的话，我是直接把雷池安装到 A 机器的，但由于我的 A 机器本身就装了Nginx去反代 B，所以雷池就不能再占用 80 和 443 口了。

我给雷池用9999端口，然后打源站B，配置如下，打码的地方填源站：

![](https://pic.oo1.win/i/0/2023/12/18/xoaqwx-0.png)

然后原来的 Nginx反代，本来是反代源站的。

现在改成反代本地的9999端口，宝塔配置如下：

![](https://pic.oo1.win/i/0/2023/12/18/xoyahi-0.png)

于是新的网络流量路径是这样的：

对外暴露A的IP，打到 A 的 Nginx，Nginx 打到雷池，雷池过滤恶意流量后请求源站。

# 反代雷池控制台

对于雷池控制台，因为需要 https 访问，一直用 ip:port 就很难受。

我就外层配了个反代， waf.abc.com 到雷池控制台。

**这里有个坑** ，就是反代的时候路径一定要写 https ，不然走 http 到控制台，会被直接拦截。配置如下

![](https://pic.oo1.win/i/0/2023/12/18/xqtex2-0.png)


